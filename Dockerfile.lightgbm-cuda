# üöÄ Dockerfile - LightGBM com CUDA (2025)
# Baseado em nvidia/cuda:12.8.0-cudnn-devel-ubuntu22.04 com LightGBM compilado com CUDA

FROM nvidia/cuda:12.8.0-cudnn-devel-ubuntu22.04

# Definir vari√°veis de ambiente
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    CUDA_HOME=/usr/local/cuda \
    PATH=/usr/local/cuda/bin:$PATH \
    LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

# ============================================================================
# 1. Instalar depend√™ncias do sistema
# ============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    git \
    curl \
    wget \
    ca-certificates \
    libboost-dev \
    libboost-system-dev \
    libboost-filesystem-dev \
    libboost-program-options-dev \
    libboost-thread-dev \
    libboost-regex-dev \
    libboost-date-time-dev \
    gcc \
    g++ \
    gfortran \
    python3 \
    python3-dev \
    python3-pip \
    python3-setuptools \
    libopenblas-dev \
    liblapack-dev \
    libblas-dev \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# 2. Configurar OpenCL para NVIDIA GPU
# ============================================================================
RUN mkdir -p /etc/OpenCL/vendors && \
    echo "libnvidia-opencl.so.1" > /etc/OpenCL/vendors/nvidia.icd

# ============================================================================
# 3. Compilar LightGBM com CUDA
# ============================================================================
RUN cd /tmp && \
    git clone --recursive --branch stable --depth 1 https://github.com/microsoft/LightGBM && \
    cd LightGBM && \
    mkdir build && \
    cd build && \
    cmake -DUSE_GPU=1 \
          -DUSE_CUDA=1 \
          -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda \
          -DOpenCL_LIBRARY=/usr/local/cuda/lib64/libOpenCL.so \
          -DOpenCL_INCLUDE_DIR=/usr/local/cuda/include \
          -DCMAKE_CUDA_ARCHITECTURES=75 \
          .. && \
    make -j$(nproc) && \
    make install && \
    cd /tmp/LightGBM && \
    pip install --no-cache-dir . && \
    cd / && \
    rm -rf /tmp/LightGBM

# ============================================================================
# 4. Instalar Python packages
# ============================================================================
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir \
    numpy \
    pandas \
    scikit-learn \
    xgboost \
    optuna \
    sqlmodel \
    fastapi \
    uvicorn \
    pydantic \
    python-dotenv \
    structlog \
    sqlalchemy \
    psycopg2-binary \
    celery \
    redis \
    requests \
    holidays \
    python-multipart \
    aiofiles \
    langchain \
    langgraph \
    langsmith

# ============================================================================
# 5. Verificar instala√ß√£o de LightGBM com CUDA
# ============================================================================
RUN python3 -c "import lightgbm as lgb; print('LightGBM version:', lgb.__version__); m = lgb.LGBMRegressor(device_type='cuda', n_estimators=1); print('‚úÖ LightGBM com CUDA OK')"

# ============================================================================
# 6. Copiar aplica√ß√£o
# ============================================================================
WORKDIR /app

COPY . .

# ============================================================================
# 7. Expor porta
# ============================================================================
EXPOSE 8000

# ============================================================================
# 8. Comando padr√£o
# ============================================================================
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
