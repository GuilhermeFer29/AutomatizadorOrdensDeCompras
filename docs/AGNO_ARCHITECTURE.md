# üèóÔ∏è Arquitetura Agno - Sistema de Automa√ß√£o de Ordens de Compra

## üìê Vis√£o Geral da Arquitetura

O sistema utiliza o framework **Agno** para orquestrar m√∫ltiplos agentes especializados que colaboram na an√°lise e tomada de decis√£o sobre ordens de compra.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      FRONTEND / API                              ‚îÇ
‚îÇ                    (FastAPI Endpoints)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               CONVERSATIONAL AGENT (NLU)                         ‚îÇ
‚îÇ  - Extra√ß√£o de Entidades (Agno Agent)                           ‚îÇ
‚îÇ  - Resolu√ß√£o de Contexto (RAG)                                  ‚îÇ
‚îÇ  - Roteamento de Intents                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               SUPPLY CHAIN TEAM (Agno Team)                     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  1. ANALISTA DE DEMANDA                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Analisa estoque atual vs. m√≠nimo                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Avalia previs√£o de demanda (LightGBM)              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Decide: need_restock? (true/false)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Tools: lookup_product, load_demand_forecast        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚Üì                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  2. PESQUISADOR DE MERCADO                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Scraping de pre√ßos (Mercado Livre)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Busca contexto web (Tavily)                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Pesquisa enciclop√©dica (Wikipedia)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Tools: scrape_latest_price, tavily_search,         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ              wikipedia_search                             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚Üì                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  3. ANALISTA DE LOG√çSTICA                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Avalia dist√¢ncias e custos de transporte           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Calcula custo total de aquisi√ß√£o                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Seleciona melhor oferta                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Tools: compute_distance                            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                             ‚Üì                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  4. GERENTE DE COMPRAS                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Consolida todas as an√°lises                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Avalia riscos                                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Decis√£o final: approve/reject/manual_review        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     - Gera justificativa e pr√≥ximos passos               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    RESPONSE FORMATTER                            ‚îÇ
‚îÇ  - Traduz resposta t√©cnica para linguagem natural               ‚îÇ
‚îÇ  - Formata em Markdown                                          ‚îÇ
‚îÇ  - Adiciona emojis e estrutura                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß© Componentes Principais

### 1. **Conversational Agent** (`app/agents/conversational_agent.py`)

**Responsabilidade:** Orquestrador principal - interface entre usu√°rio e sistema

**Componentes:**
- **Entity Extractor Agent (Agno):**
  - Extrai: SKU, produto, intent, quantidade
  - Usa RAG para resolver refer√™ncias pronominais
  - Fallback para regex se LLM falhar

- **Session Context Manager:**
  - Mant√©m contexto entre mensagens
  - Armazena em banco de dados (ChatContext)

- **Intent Router:**
  - `forecast` ‚Üí Supply Chain Team
  - `price_check` ‚Üí Supply Chain Team
  - `stock_check` ‚Üí Consulta direta ao BD
  - `purchase_decision` ‚Üí Supply Chain Team
  - `logistics` ‚Üí Supply Chain Team
  - `general_inquiry` ‚Üí Clarifica√ß√£o

**Modelo:** OpenRouter (configur√°vel via env)

---

### 2. **Supply Chain Team** (`app/agents/supply_chain_team.py`)

**Responsabilidade:** Pipeline de an√°lise sequencial para decis√£o de compra

**Arquitetura Agno:**
```python
Team(
    name="SupplyChainTeam",
    agents=[
        analista_demanda,
        pesquisador_mercado,
        analista_logistica,
        gerente_compras
    ],
    mode="sequential"
)
```

**Fluxo de Dados:**
```
Input: SKU + Inquiry Reason
  ‚Üì
Analista Demanda ‚Üí { need_restock, justification, confidence_level }
  ‚Üì
Pesquisador Mercado ‚Üí { offers[], market_context }
  ‚Üì
Analista Log√≠stica ‚Üí { selected_offer, analysis_notes, alternatives[] }
  ‚Üì
Gerente Compras ‚Üí { decision, supplier, price, rationale, next_steps[], risk_assessment }
  ‚Üì
Output: Recomenda√ß√£o Final
```

**Configura√ß√£o do Modelo:**
- Cada agente usa `agno.models.openai.OpenAI`
- Endpoint: OpenRouter API
- Temperatura: 0.1 - 0.2 (precis√£o sobre criatividade)

---

### 3. **Supply Chain Toolkit** (`app/agents/tools.py`)

**Responsabilidade:** Biblioteca de ferramentas para os agentes

**Classe:** `SupplyChainToolkit(Toolkit)`

**Ferramentas:**

| Ferramenta | Fun√ß√£o | Agente Principal |
|------------|--------|------------------|
| `lookup_product` | Consulta produto no BD | Analista Demanda |
| `load_demand_forecast` | Previs√£o LightGBM | Analista Demanda |
| `scrape_latest_price` | Scraping Mercado Livre | Pesquisador Mercado |
| `wikipedia_search` | Contexto enciclop√©dico | Pesquisador Mercado |
| `tavily_search` | Busca web atualizada | Pesquisador Mercado |
| `compute_distance` | C√°lculo de dist√¢ncias | Analista Log√≠stica |

**Formato de Retorno:** JSON string (parse autom√°tico pelo Agno)

---

### 4. **RAG Service** (`app/services/rag_service.py`)

**Responsabilidade:** Retrieval-Augmented Generation para contexto sem√¢ntico

**Stack Tecnol√≥gico:**
- **Vector DB:** ChromaDB (persistente)
- **Embeddings:** OpenAI `text-embedding-3-small` via OpenRouter
- **Collections:**
  - `chat_history` - Hist√≥rico de mensagens
  - `products` - Cat√°logo de produtos

**Fluxo RAG:**
```
User Query ‚Üí Embedding (OpenRouter) ‚Üí ChromaDB Query ‚Üí Top-K Results ‚Üí Context Injection
```

**APIs Principais:**
- `index_chat_message(message)` - Indexa mensagem
- `index_product_catalog(session)` - Indexa produtos
- `semantic_search_messages(query, session_id, k)` - Busca sem√¢ntica
- `get_relevant_context(query, session)` - Contexto para NLU

---

### 5. **Agent Service** (`app/services/agent_service.py`)

**Responsabilidade:** Camada de servi√ßo entre API e Team

**Fun√ß√£o Principal:**
```python
execute_supply_chain_analysis(sku: str, inquiry_reason: str) -> Dict
```

**Features:**
- Logging estruturado (structlog)
- Valida√ß√£o de entrada
- Tratamento de exce√ß√µes
- Defaults para campos obrigat√≥rios

---

## üîÑ Fluxo de Execu√ß√£o Completo

### Exemplo: "Preciso comprar 50 unidades do SKU_001"

```
1. API Endpoint (/api/chat)
   ‚Üì
2. Conversational Agent - extract_entities()
   ‚Üí NLU Agent (Agno) extrai:
     {
       "sku": "SKU_001",
       "intent": "purchase_decision",
       "quantity": 50,
       "confidence": "high"
     }
   ‚Üì
3. route_to_specialist()
   ‚Üí Retorna: { "agent": "supply_chain_analysis", "async": True }
   ‚Üì
4. execute_supply_chain_team(sku="SKU_001")
   ‚Üì
5. Team Sequencial (Agno):
   
   a) Analista Demanda:
      - lookup_product("SKU_001") ‚Üí estoque_atual=20, estoque_minimo=50
      - load_demand_forecast("SKU_001") ‚Üí tend√™ncia crescente
      ‚Üí need_restock=True, justification="Estoque abaixo do m√≠nimo"
   
   b) Pesquisador Mercado:
      - scrape_latest_price("SKU_001") ‚Üí R$ 150.00 (Fornecedor A)
      - tavily_search("SKU_001 pre√ßo") ‚Üí contexto de mercado
      ‚Üí offers=[{source: "Fornecedor A", price: 150.00, ...}]
   
   c) Analista Log√≠stica:
      - compute_distance(origem, destino) ‚Üí 120 km
      - Calcula custo total ‚Üí R$ 150.00 + R$ 30.00 (frete) = R$ 180.00
      ‚Üí selected_offer={source: "Fornecedor A", estimated_total_cost: 180.00}
   
   d) Gerente Compras:
      - Analisa: estoque baixo + pre√ßo aceit√°vel + log√≠stica vi√°vel
      ‚Üí decision="approve", rationale="Compra recomendada...", risk_assessment="Baixo"
   ‚Üì
6. format_agent_response()
   ‚Üí Converte JSON t√©cnico para linguagem natural com emojis
   ‚Üì
7. Response ao usu√°rio:
   "‚úÖ Recomendo aprovar a compra:
    üì¶ Fornecedor: Fornecedor A
    üí∞ Pre√ßo: BRL 150.00
    üìä Quantidade: 50 unidades
    ..."
```

---

## ‚öôÔ∏è Configura√ß√£o OpenRouter

### Vari√°veis de Ambiente
```bash
OPENROUTER_API_KEY=sk-or-v1-...
OPENROUTER_API_BASE=https://openrouter.ai/api/v1
OPENROUTER_MODEL_NAME=mistralai/mistral-small-3.1-24b-instruct:free
```

### Como Funciona
```python
# Agno usa o cliente OpenAI internamente
OpenAI(
    model="mistralai/mistral-small-3.1-24b-instruct:free",
    api_key=os.getenv("OPENROUTER_API_KEY"),
    base_url="https://openrouter.ai/api/v1"  # ‚Üê Redirecionamento
)
```

OpenRouter atua como **proxy** para m√∫ltiplos provedores de LLM (Anthropic, Meta, Mistral, etc.)

---

## üéØ Padr√µes de Design Utilizados

### 1. **Strategy Pattern**
Cada agente √© uma estrat√©gia especializada para uma etapa da an√°lise.

### 2. **Chain of Responsibility**
Fluxo sequencial onde cada agente processa e enriquece o estado.

### 3. **Repository Pattern**
`SupplyChainToolkit` abstrai acesso a dados e servi√ßos externos.

### 4. **Facade Pattern**
`agent_service.py` fornece interface simplificada para o sistema complexo.

---

## üìä M√©tricas e Monitoramento

### Logs Estruturados (structlog)
```python
LOGGER.info("agents.analysis.start", sku=sku, inquiry_reason=inquiry_reason)
LOGGER.info("agents.analysis.completed", sku=sku)
LOGGER.exception("agents.analysis.error", sku=sku, error=str(exc))
```

### M√©tricas Importantes
- **Lat√™ncia Total:** Tempo desde request at√© response
- **Token Usage:** Rastreado via OpenRouter dashboard
- **Cache Hit Rate:** ChromaDB (RAG)
- **Success Rate:** % de an√°lises completas vs. erros

---

## üîí Seguran√ßa e Resili√™ncia

### 1. **Valida√ß√£o de Entrada**
```python
if not sku.strip():
    raise ValueError("O SKU informado n√£o pode ser vazio.")
```

### 2. **Fallbacks**
- NLU: LLM ‚Üí Regex
- RAG: Embedding error ‚Üí Vetor zero
- Tools: Exception ‚Üí JSON com erro

### 3. **Timeouts**
Configur√°vel no Agno via `model.timeout`

### 4. **Rate Limiting**
Gerenciado pelo OpenRouter (incluso no plano)

---

## üöÄ Performance

### Otimiza√ß√µes Implementadas
1. **Cache de LLM:** Cliente OpenAI reutilizado (singleton)
2. **Persist√™ncia ChromaDB:** Embeddings salvos em disco
3. **Temperature baixa:** Respostas mais determin√≠sticas (menos tokens)
4. **Mode sequential:** Paraleliza√ß√£o quando poss√≠vel no futuro

### Benchmarks Esperados
- **Extra√ß√£o de Entidades:** ~2-3s
- **Team Completo:** ~15-30s (depende de scraping)
- **RAG Lookup:** ~200-500ms

---

## üîÆ Roadmap Futuro

### Melhorias Planejadas
1. **Modo Paralelo:** Agentes que n√£o dependem entre si rodarem em paralelo
2. **Streaming:** Respostas em tempo real via Server-Sent Events
3. **Fine-tuning:** Modelo customizado para intents espec√≠ficos
4. **A/B Testing:** Comparar diferentes configura√ß√µes de agentes
5. **Auto-Healing:** Retry autom√°tico com fallback models

---

## üìö Refer√™ncias

- **Agno Docs:** https://docs.agno.com/
- **OpenRouter:** https://openrouter.ai/docs
- **ChromaDB:** https://docs.trychroma.com/
- **FastAPI:** https://fastapi.tiangolo.com/

---

**√öltima atualiza√ß√£o:** 2025-10-09  
**Vers√£o da Arquitetura:** 2.0 (Agno)  
**Autor:** Sistema de Automa√ß√£o de Ordens de Compra
